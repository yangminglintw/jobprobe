# JProbe 產品需求文件

| 項目 | 內容 |
|------|------|
| **產品名稱** | JProbe |
| **版本** | 0.1.0 (MVP) |
| **作者** | DevOps/SRE 團隊 |
| **最後更新** | 2026-01-21 |
| **狀態** | MVP 已完成 |

---

## 1. 概述

JProbe 是一個輕量級 CLI 工具，提供 Rundeck 任務與 HTTP API 端點的統一健康檢查功能。它讓 DevOps/SRE 團隊能透過單一、一致的介面驗證基礎設施健康狀態。

### 1.1 願景

一個指令即可驗證所有關鍵系統在部署後或事件處理期間是否正常運作。

### 1.2 核心價值主張

- **統一工具**：一個工具同時支援任務調度（Rundeck）與 HTTP 健康檢查
- **按需驗證**：需要時執行檢查，非持續監控
- **CI/CD 原生**：JSON 輸出、exit codes、容器化部署
- **自託管**：無外部依賴，單一執行檔

---

## 2. 問題陳述

### 2.1 目前痛點

| 痛點 | 影響 |
|------|------|
| **手動驗證** | 工程師花費大量時間手動檢查任務狀態與 API 回應 |
| **工具分散** | Rundeck 與 HTTP 檢查使用不同的腳本和工具 |
| **結果不一致** | 不同工程師使用不同方法，導致驗證結果不一致 |
| **無 E2E 測試** | 過去依賴使用者回報才能發現問題 |
| **多站點複雜度** | 跨多個環境管理健康檢查非常困難 |

### 2.2 使用者影響

- 事件偵測延遲
- 維運負擔增加
- 對部署驗證缺乏信心
- 難以將健康檢查整合至 CI/CD 流程

### 2.3 業務影響

- 故障偵測時間延長
- 手動作業與維運成本增加
- 正式環境問題未被發現的風險

---

## 3. 目標與成功指標

### 3.1 主要目標

1. 減少 90% 手動驗證時間
2. 提供跨所有系統一致的健康檢查方法
3. 實現 CI/CD 整合以自動化部署驗證
4. 透過快速系統健康驗證改善事件回應

### 3.2 關鍵績效指標 (KPIs)

| KPI | 目標 |
|-----|------|
| 驗證所有關鍵系統的時間 | < 5 分鐘 |
| 手動驗證時間減少 | 90% |
| CI/CD 整合成功率 | 100% |
| 誤報率 | < 1% |

### 3.3 非目標（範圍外）

- 持續即時監控（請使用 Datadog/Prometheus）
- 超出健康檢查的複雜測試情境
- 資料轉換或 ETL 操作
- 任務排程（JProbe 觸發任務，不負責排程）

---

## 4. 使用者角色

### 4.1 主要：DevOps/SRE 工程師

| 屬性 | 描述 |
|------|------|
| **角色** | DevOps/SRE 工程師（通常也是開發者） |
| **目標** | 在部署後或事件期間快速驗證系統健康 |
| **痛點** | 手動檢查多個系統耗時且容易出錯 |
| **需求** | 一個工具驗證 Rundeck 任務與 HTTP 端點 |

### 4.2 次要：CI/CD Pipeline

| 屬性 | 描述 |
|------|------|
| **角色** | 自動化部署流程 |
| **目標** | 部署後執行端對端驗證 |
| **需求** | 機器可讀輸出、exit codes、容器化執行 |

---

## 5. 使用者故事

### 5.1 核心使用者故事

| ID | 作為... | 我想要... | 以便... |
|----|---------|-----------|---------|
| US-001 | DevOps 工程師 | 用單一指令執行健康檢查 | 快速驗證系統健康 |
| US-002 | DevOps 工程師 | 依標籤過濾檢查 | 只執行關鍵檢查 |
| US-003 | DevOps 工程師 | 依環境過濾檢查 | 驗證特定環境 |
| US-004 | CI/CD Pipeline | 取得 JSON 輸出 | 程式化解析結果 |
| US-005 | CI/CD Pipeline | 取得適當的 exit codes | 在檢查失敗時讓 pipeline 失敗 |
| US-006 | DevOps 工程師 | 預覽檢查而不執行 | 安全地驗證設定 |
| US-007 | DevOps 工程師 | 看到彩色進度輸出 | 快速了解檢查狀態 |

### 5.2 情境範例

**情境 1：部署後驗證**
```bash
# 部署到正式環境後
jprobe run --tags critical --env prod
```

**情境 2：CI/CD Pipeline 整合**
```yaml
verify:
  script:
    - jprobe run --tags critical --output json > results.json
    - if [ $? -ne 0 ]; then exit 1; fi
```

**情境 3：事件回應**
```bash
# 事件期間快速健康檢查
jprobe run --tags critical
```

---

## 6. 功能需求

### 6.1 任務執行

| ID | 需求 | 優先級 | 狀態 |
|----|------|--------|------|
| FR-001 | 透過 API 觸發 Rundeck 任務 | P0 | 完成 |
| FR-002 | 輪詢執行狀態直到完成 | P0 | 完成 |
| FR-003 | 驗證任務最終狀態（成功/失敗） | P0 | 完成 |
| FR-004 | 支援任務選項/參數 | P1 | 完成 |
| FR-005 | 處理執行逾時 | P0 | 完成 |
| FR-006 | 可設定的輪詢間隔 | P1 | 完成 |

### 6.2 HTTP 健康檢查

| ID | 需求 | 優先級 | 狀態 |
|----|------|--------|------|
| FR-010 | 支援 GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS 方法 | P0 | 完成 |
| FR-011 | 斷言 HTTP 狀態碼 | P0 | 完成 |
| FR-012 | 使用 JSONPath 斷言 JSON 回應 | P0 | 完成 |
| FR-013 | 支援請求標頭 | P1 | 完成 |
| FR-014 | 支援請求內容 | P1 | 完成 |
| FR-015 | 支援認證（bearer, basic, api_key） | P1 | 完成 |
| FR-016 | 斷言回應時間 | P2 | 完成 |

### 6.3 過濾與選擇

| ID | 需求 | 優先級 | 狀態 |
|----|------|--------|------|
| FR-020 | 依標籤過濾 (--tags) | P0 | 完成 |
| FR-021 | 依環境過濾 (--env) | P0 | 完成 |
| FR-022 | 依任務名稱過濾 (--name) | P1 | 完成 |

### 6.4 設定

| ID | 需求 | 優先級 | 狀態 |
|----|------|--------|------|
| FR-030 | YAML 設定檔 | P0 | 完成 |
| FR-031 | 環境變數展開 ${VAR} | P0 | 完成 |
| FR-032 | 多檔案設定（config, environments, jobs） | P1 | 完成 |
| FR-033 | 設定驗證 | P1 | 完成 |
| FR-034 | 預設值與單一任務覆寫 | P2 | 完成 |

### 6.5 輸出與報告

| ID | 需求 | 優先級 | 狀態 |
|----|------|--------|------|
| FR-040 | 彩色終端機輸出 | P0 | 完成 |
| FR-041 | JSON 輸出格式 | P0 | 完成 |
| FR-042 | 美化 JSON (--pretty) | P2 | 完成 |
| FR-043 | 執行期間的進度顯示 | P1 | 完成 |
| FR-044 | 通過/失敗計數摘要 | P0 | 完成 |

### 6.6 執行模式

| ID | 需求 | 優先級 | 狀態 |
|----|------|--------|------|
| FR-050 | Dry-run 模式 (--dry-run) | P1 | 完成 |
| FR-051 | 詳細模式 (-v, --verbose) | P2 | 完成 |

### 6.7 未來需求

| ID | 需求 | 優先級 | 狀態 |
|----|------|--------|------|
| FR-060 | 並行執行 | P0 | 規劃中 |
| FR-061 | Webhook 通知 | P1 | 規劃中 |
| FR-062 | Jenkins provider | P2 | 規劃中 |
| FR-063 | Airflow provider | P2 | 規劃中 |
| FR-064 | 重試機制 | P1 | 規劃中 |

---

## 7. 非功能需求

### 7.1 效能

| ID | 需求 | 目標 |
|----|------|------|
| NFR-001 | CLI 負擔 | < 100ms 啟動時間 |
| NFR-002 | 記憶體使用量 | 執行期間 < 50MB |
| NFR-003 | 執行檔大小 | < 15MB |
| NFR-004 | 並行任務數（未來） | 支援 10+ 個平行任務 |

### 7.2 可靠性

| ID | 需求 | 目標 |
|----|------|------|
| NFR-010 | 網路逾時處理 | 優雅失敗並提供清楚錯誤訊息 |
| NFR-011 | 無效設定處理 | 執行前驗證 |
| NFR-012 | 部分失敗處理 | 任務失敗時繼續執行，報告所有結果 |

### 7.3 安全性

| ID | 需求 | 目標 |
|----|------|------|
| NFR-020 | 憑證處理 | 僅使用環境變數，永不存於檔案 |
| NFR-021 | 不記錄憑證 | 憑證永不出現在輸出中 |
| NFR-022 | TLS 支援 | 所有遠端連線使用 HTTPS |

### 7.4 易用性

| ID | 需求 | 目標 |
|----|------|------|
| NFR-030 | 清楚的錯誤訊息 | 可操作的錯誤描述 |
| NFR-031 | CLI 說明 | 完整的 --help 輸出 |
| NFR-032 | 進度可見性 | 清楚顯示目前狀態 |
| NFR-033 | 彩色輸出 | 一眼區分通過/失敗 |

### 7.5 可攜性

| ID | 需求 | 目標 |
|----|------|------|
| NFR-040 | Linux 支援 | AMD64, ARM64 |
| NFR-041 | macOS 支援 | AMD64, ARM64 |
| NFR-042 | Windows 支援 | AMD64 |
| NFR-043 | Docker 支援 | Multi-stage build, scratch base |

---

## 8. 技術架構

詳細架構請參閱 [PLAN.md](../PLAN.md)。

### 8.1 高階架構

```
CLI 層 → 設定層 → 執行引擎 → Provider 層 → 輸出層
```

### 8.2 關鍵設計決策

| 決策 | 選擇 | 理由 |
|------|------|------|
| 語言 | Go | 單一執行檔、DevOps 生態系、效能、跨平台編譯 |
| 設定 | YAML | 簡單、版本控制友善、符合 GitOps |
| CLI 框架 | Cobra | Go 標準 CLI 函式庫、自動產生說明 |
| Provider 模式 | Interface + Registry | 容易新增 provider |

### 8.3 核心元件

1. **CLI 層**：基於 Cobra 的指令解析
2. **設定層**：YAML 載入、驗證、環境變數展開
3. **執行引擎**：循序執行（未來支援並行）
4. **Provider 層**：Rundeck, HTTP（未來支援 Jenkins, Airflow）
5. **輸出層**：Console, JSON（未來支援 JUnit）

---

## 9. 技術替代方案分析

### 9.1 為什麼自己開發

| 替代方案 | 不適合的原因 |
|----------|-------------|
| Rundeck CLI + curl | 需要自訂 glue scripts，難以維護 |
| Postman Collections | 不支援 Rundeck，需要 GUI |
| Shell Scripts | 分散、團隊成員間不一致 |
| Ansible | 對簡單健康檢查來說太重 |
| Terraform checks | 只有 HTTP，不支援任務調度 |
| pytest | 需要 Python 環境，非原生 Rundeck 支援 |

### 9.2 市場缺口

目前沒有工具同時提供：

1. Rundeck 任務執行與非同步輪詢
2. HTTP 端點斷言（狀態 + JSON）
3. 統一的 YAML 設定
4. 按需執行（非持續監控）
5. CLI 介面與 CI/CD 整合
6. 自託管、單一執行檔部署

**結論**：開發 JProbe 填補了 DevOps 工具生態系的真正缺口。

### 9.3 競爭環境

| 類別 | 工具 | JProbe 優勢 |
|------|------|-------------|
| 任務調度 CLI | Rundeck CLI, Jenkins CLI, Airflow CLI | 多系統統一介面 |
| HTTP 測試 | curl, httpie, Postman, Hurl, Tavern | 整合任務調度支援 |
| 健康檢查工具 | Checkup, Healthchecks.io | 按需 + Rundeck 支援 |
| 監控平台 | Datadog, Prometheus | 互補（按需 vs 持續） |

---

## 10. 依賴項

### 10.1 外部依賴

| 依賴 | 類型 | 必要性 |
|------|------|--------|
| Rundeck API (v41+) | 執行時期 | 用於 Rundeck 任務 |
| HTTP APIs | 執行時期 | 用於 HTTP 檢查 |
| Go 1.23+ | 建置 | 僅開發時需要 |

### 10.2 Go 函式庫

| 函式庫 | 用途 |
|--------|------|
| spf13/cobra | CLI 框架 |
| spf13/viper | 設定管理 |
| fatih/color | 彩色輸出 |
| ohler55/ojg | JSON path 斷言 |

---

## 11. 風險與緩解

| 風險 | 影響 | 可能性 | 緩解措施 |
|------|------|--------|----------|
| 大量任務時效能下降 | 高 | 中 | 實作並行執行（規劃中） |
| 技術債累積 | 中 | 中 | 維護乾淨架構、程式碼審查 |
| 認證失敗 | 中 | 低 | 清楚錯誤訊息、dry-run 模式 |
| 網路逾時問題 | 中 | 中 | 可設定逾時、重試機制（規劃中） |
| 設定錯誤 | 低 | 中 | 執行前驗證、dry-run 模式 |

---

## 12. 發布計畫

### 12.1 目前版本：v0.1.0 (MVP)

**狀態**：已完成

- 核心 Rundeck provider
- HTTP provider 含斷言
- YAML 設定
- Console 與 JSON 輸出
- 標籤、環境、名稱過濾
- Dry-run 模式
- Docker 支援

### 12.2 規劃中：v0.2.0

**重點**：效能與可靠性

- 並行任務執行
- 重試機制
- 改善錯誤訊息

### 12.3 規劃中：v0.3.0

**重點**：通知

- Webhook 通知
- 彈性通知目標

### 12.4 未來考量

- Jenkins provider
- Airflow provider
- Prometheus metrics 輸出
- Web UI（選用）

---

## 13. 附錄

### 13.1 Exit Codes

| 代碼 | 意義 |
|------|------|
| 0 | 所有任務通過 |
| 1 | 一個或多個任務失敗 |
| 2 | 設定錯誤 |
| 3 | 執行時錯誤（網路、認證等） |

### 13.2 設定範例

```yaml
# config.yaml
defaults:
  timeout: 10m
  poll_interval: 10s

# environments.yaml
environments:
  rundeck-prod:
    type: rundeck
    url: https://rundeck.example.com
    auth:
      token: ${RUNDECK_TOKEN}

# jobs/critical.yaml
jobs:
  - name: api-health
    environment: api-prod
    type: http
    method: GET
    path: /health
    assertions:
      status_code: 200
      json:
        - path: $.status
          equals: "healthy"
    tags:
      - critical
```

### 13.3 相關文件

- [PR-FAQ](./PR-FAQ.md) - Press Release / FAQ 文件
- [PLAN.md](../PLAN.md) - 技術實作計畫
- [README.md](../README.md) - 使用者文件
