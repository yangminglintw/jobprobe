# JProbe 技術規格

本技術規格供 PM 和 Tech Lead 了解範圍、需求和產品路線圖。

---

## 1. 產品概述

| 項目 | 內容 |
|------|------|
| **名稱** | JProbe |
| **版本** | 0.1.0 (MVP) |
| **狀態** | MVP 已完成 |
| **類型** | CLI 工具 |

**一句話描述**：統一的健康檢查 CLI，支援 Rundeck 作業和 HTTP 端點。

**願景**：使用單一指令，在部署後或事故回應期間驗證所有關鍵系統是否正常運作。

---

## 2. 問題陳述

### 2.1 痛點

| 痛點 | 影響 |
|------|------|
| 手動驗證 | 耗時且容易出錯 |
| 工具分散 | Rundeck 和 HTTP 使用不同腳本 |
| 結果不一致 | 團隊成員使用不同方法 |
| 無端對端測試 | 依賴使用者回報才發現問題 |
| 多站點複雜性 | 跨環境管理健康檢查困難 |

### 2.2 業務影響

- 延長故障偵測時間
- 增加手動工作和營運成本
- 生產環境問題未被察覺的風險
- 對部署驗證缺乏信心

### 2.3 市場缺口

沒有現有工具能同時提供：
1. Rundeck 作業執行與非同步輪詢
2. HTTP 端點斷言（狀態碼 + JSON）
3. 統一的 YAML 設定
4. 按需執行（非持續監控）
5. CLI 介面與 CI/CD 整合
6. 自託管、單一執行檔部署

---

## 3. 目標與 KPI

### 3.1 主要目標

1. 減少 90% 手動驗證時間
2. 提供一致的健康檢查方法
3. 實現 CI/CD 整合以自動化驗證
4. 透過快速健康驗證改善事故回應

### 3.2 關鍵績效指標

| KPI | 目標 |
|-----|------|
| 驗證所有關鍵系統的時間 | < 5 分鐘 |
| CI/CD 整合成功率 | 100% |
| 誤報率 | < 1% |

### 3.3 非目標

- 持續即時監控（使用 Datadog/Prometheus）
- 超出健康檢查的複雜測試情境
- 資料轉換或 ETL 操作
- 作業排程（JProbe 觸發，不排程）

---

## 4. 使用者角色

### 4.1 主要：DevOps/SRE 工程師

| 屬性 | 描述 |
|------|------|
| **角色** | DevOps/SRE 工程師 |
| **目標** | 在部署後或事故期間快速驗證系統健康 |
| **痛點** | 手動檢查多個系統耗時費力 |
| **需求** | 單一工具驗證 Rundeck 作業和 HTTP 端點 |

### 4.2 次要：CI/CD Pipeline

| 屬性 | 描述 |
|------|------|
| **角色** | 自動化部署管線 |
| **目標** | 部署後執行端對端驗證 |
| **需求** | 機器可讀輸出、結束碼、容器化執行 |

---

## 5. 使用者故事

| ID | 作為... | 我想要... | 以便... |
|----|---------|-----------|---------|
| US-001 | DevOps 工程師 | 用單一指令執行健康檢查 | 快速驗證系統健康 |
| US-002 | DevOps 工程師 | 依標籤過濾檢查 | 只執行關鍵檢查 |
| US-003 | DevOps 工程師 | 依環境過濾檢查 | 驗證特定環境 |
| US-004 | CI/CD 管線 | 取得 JSON 輸出 | 程式化解析結果 |
| US-005 | CI/CD 管線 | 取得適當結束碼 | 在檢查失敗時中止管線 |
| US-006 | DevOps 工程師 | 預覽檢查而不執行 | 安全驗證設定 |
| US-007 | DevOps 工程師 | 看到彩色進度輸出 | 快速了解檢查狀態 |

---

## 6. 功能需求

### 6.1 作業執行 (P0)

| ID | 需求 | 狀態 |
|----|------|------|
| FR-001 | 透過 API 觸發 Rundeck 作業 | 完成 |
| FR-002 | 輪詢執行狀態直到完成 | 完成 |
| FR-003 | 驗證作業最終狀態（成功/失敗） | 完成 |
| FR-004 | 支援作業選項/參數 | 完成 |
| FR-005 | 處理執行逾時 | 完成 |
| FR-006 | 可設定輪詢間隔 | 完成 |

### 6.2 HTTP 健康檢查 (P0)

| ID | 需求 | 狀態 |
|----|------|------|
| FR-010 | 支援所有 HTTP 方法 (GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS) | 完成 |
| FR-011 | 斷言 HTTP 狀態碼 | 完成 |
| FR-012 | 使用 JSONPath 斷言 JSON 回應 | 完成 |
| FR-013 | 支援請求標頭 | 完成 |
| FR-014 | 支援請求主體 | 完成 |
| FR-015 | 支援認證 (bearer, basic, api_key) | 完成 |
| FR-016 | 斷言回應時間 | 完成 |

### 6.3 過濾與選擇 (P0)

| ID | 需求 | 狀態 |
|----|------|------|
| FR-020 | 依標籤過濾 (--tags) | 完成 |
| FR-021 | 依環境過濾 (--env) | 完成 |
| FR-022 | 依作業名稱過濾 (--name) | 完成 |

### 6.4 設定 (P0/P1)

| ID | 需求 | 優先級 | 狀態 |
|----|------|--------|------|
| FR-030 | YAML 設定檔 | P0 | 完成 |
| FR-031 | 環境變數展開 ${VAR} | P0 | 完成 |
| FR-032 | 多檔案設定 | P1 | 完成 |
| FR-033 | 設定驗證 | P1 | 完成 |
| FR-034 | 預設值與作業層級覆蓋 | P2 | 完成 |

### 6.5 輸出與報告 (P0)

| ID | 需求 | 狀態 |
|----|------|------|
| FR-040 | 彩色 Console 輸出 | 完成 |
| FR-041 | JSON 輸出格式 | 完成 |
| FR-042 | 美化列印 JSON (--pretty) | 完成 |
| FR-043 | 執行時進度顯示 | 完成 |
| FR-044 | 通過/失敗計數摘要 | 完成 |

### 6.6 執行模式 (P1)

| ID | 需求 | 狀態 |
|----|------|------|
| FR-050 | 試執行模式 (--dry-run) | 完成 |
| FR-051 | 詳細模式 (-v, --verbose) | 完成 |

### 6.7 計畫功能 (P1/P2)

| ID | 需求 | 優先級 | 狀態 |
|----|------|--------|------|
| FR-060 | 平行執行 | P0 | 計畫中 |
| FR-061 | 重試機制 | P1 | 計畫中 |
| FR-062 | Webhook 通知 | P1 | 計畫中 |
| FR-063 | Jenkins provider | P2 | 計畫中 |
| FR-064 | Airflow provider | P2 | 計畫中 |

---

## 7. 非功能需求

### 7.1 效能

| 指標 | 目標 |
|------|------|
| CLI 啟動時間 | < 100ms |
| 記憶體使用量 | < 50MB |
| 執行檔大小 | < 15MB |
| 並行作業（未來） | 10+ 平行 |

### 7.2 可靠性

| 需求 | 描述 |
|------|------|
| 網路逾時 | 優雅失敗並提供清楚錯誤訊息 |
| 無效設定 | 執行前驗證 |
| 部分失敗 | 作業失敗時繼續，報告所有結果 |

### 7.3 安全性

| 需求 | 描述 |
|------|------|
| 憑證處理 | 僅使用環境變數，不存於檔案 |
| 不記錄憑證 | 憑證不出現在輸出中 |
| TLS 支援 | 所有遠端連線使用 HTTPS |

### 7.4 可攜性

| 平台 | 架構 |
|------|------|
| Linux | AMD64, ARM64 |
| macOS | AMD64, ARM64 |
| Windows | AMD64 |
| Docker | 多階段 Alpine 建置 |

---

## 8. 技術決策

### TD-001：語言選擇 - Go

**背景**：需要單一執行檔、符合 DevOps 生態系統
**決策**：Go 1.23
**理由**：
- 單一執行檔部署（無執行時依賴）
- 跨平台編譯
- DevOps 工具生態系統原生支援
- 強大的並行支援（未來平行執行）

### TD-002：Provider 模式

**背景**：需要可擴展架構支援多種作業系統
**決策**：介面 + Registry 模式
**理由**：
- 新增 provider 無需修改核心
- 透過 init() 執行時註冊
- 清楚的實作契約
- 易於使用 mock 測試

### TD-003：YAML 設定

**背景**：需要人類可讀、版本控制友善的設定
**決策**：YAML 搭配多檔案支援
**理由**：
- GitOps 相容
- 易於在 PR 中審查
- 支援環境變數展開
- DevOps 工程師熟悉

### TD-004：循序執行 (MVP)

**背景**：平行執行增加複雜度
**決策**：MVP 採循序執行，平行計畫中
**理由**：
- MVP 實作更簡單
- 除錯更容易
- 大多數使用情境已足夠
- 平行執行計畫於 v0.2.0

---

## 9. 依賴與風險

### 9.1 外部依賴

| 依賴 | 風險 | 緩解措施 |
|------|------|----------|
| Rundeck API v41+ | API 變更 | 版本鎖定、adapter 模式 |
| HTTP 端點 | 可用性 | 逾時處理、清楚錯誤訊息 |
| Go 1.23+ | 僅建置時 | 非執行時依賴 |

### 9.2 Go 套件

| 套件 | 用途 |
|------|------|
| spf13/cobra | CLI 框架 |
| spf13/viper | 設定管理 |
| gopkg.in/yaml.v3 | YAML 解析 |
| ohler55/ojg | JSON path 斷言 |
| fatih/color | 彩色輸出 |

### 9.3 風險評估

| 風險 | 影響 | 可能性 | 緩解措施 |
|------|------|--------|----------|
| 大量作業時效能問題 | 高 | 中 | 平行執行 (v0.2.0) |
| 認證失敗 | 中 | 低 | 清楚錯誤訊息、試執行模式 |
| 網路逾時問題 | 中 | 中 | 可設定逾時、重試（計畫中） |
| 設定錯誤 | 低 | 中 | 執行前驗證 |

---

## 10. 發布路線圖

### v0.1.0（目前）- MVP

**狀態**：完成

- 核心 Rundeck provider
- HTTP provider 含斷言
- YAML 設定
- Console 和 JSON 輸出
- 標籤、環境、名稱過濾
- 試執行模式
- Docker 支援

### v0.2.0 - 效能與可靠性

**重點**：效能最佳化

- 平行作業執行
- 重試機制與退避
- 改善錯誤訊息
- 效能分析

### v0.3.0 - 通知

**重點**：整合能力

- Webhook 通知
- Slack/Teams 整合
- 可設定通知規則
- 自訂 webhook 範本

### 未來考量

- Jenkins provider
- Airflow provider
- Prometheus 指標輸出
- Web UI 儀表板（選用）
- Kubernetes Job/CronJob provider

---

## 11. 結束碼

| 碼 | 意義 |
|----|------|
| 0 | 所有作業通過 |
| 1 | 一個以上作業失敗 |
| 2 | 設定錯誤 |
| 3 | 執行時錯誤（網路、認證等） |

---

## 12. 競爭分析

### 12.1 自建 vs 購買

| 替代方案 | 不適合原因 |
|----------|------------|
| Rundeck CLI + curl | 需要自訂整合腳本，難以維護 |
| Postman Collections | 不支援 Rundeck，需要 GUI |
| Shell Scripts | 分散、團隊間不一致 |
| Ansible | 對簡單健康檢查而言太重 |
| pytest | 需要 Python，無原生 Rundeck 支援 |

### 12.2 競爭態勢

| 類別 | 工具 | JProbe 優勢 |
|------|------|-------------|
| 作業編排 CLI | Rundeck CLI, Jenkins CLI | 統一介面 |
| HTTP 測試 | curl, httpie, Postman, Hurl | 作業編排支援 |
| 健康檢查工具 | Checkup, Healthchecks.io | 按需 + Rundeck |
| 監控 | Datadog, Prometheus | 互補（按需 vs 持續） |

---

## 13. 相關文件

- [架構文件](ARCHITECTURE-zh-TW.md) - 工程師技術深入說明
- [PR-FAQ](PR-FAQ.md) - 新聞稿與常見問題
- [測試報告](TESTING-REPORT.md) - 測試證據與覆蓋率
